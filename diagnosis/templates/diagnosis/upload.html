{% extends 'diagnosis/base.html' %}

{% block title %}上傳檢查圖片 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        padding: 40px 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .page-title {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .page-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .card {
        background: var(--card-bg);
        border: none;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .form-control {
        background: var(--bg-light);
        border: 2px solid #e2e8f0;
        color: var(--text-dark);
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background: #fff;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    .form-control::placeholder {
        color: #a0aec0;
    }

    .dropzone {
        border: 2px dashed #cbd5e0;
        border-radius: 16px;
        padding: 40px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-light);
        min-height: 240px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .dropzone:hover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.05);
    }

    .dropzone.dragover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.1);
        transform: scale(1.01);
    }

    .dropzone.has-file {
        border-color: var(--accent-color);
        background: rgba(72, 187, 120, 0.05);
    }

    .dropzone-icon {
        font-size: 3.5rem;
        color: #a0aec0;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .dropzone:hover .dropzone-icon {
        color: var(--primary-light);
        transform: scale(1.1);
    }

    .dropzone-text {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 4px;
    }

    .dropzone-subtext {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        width: 100%;
    }

    .preview-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        background: #f7fafc;
        border: 1px solid #e2e8f0;
    }

    .preview-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        display: block;
    }

    .preview-item-name {
        font-size: 0.7rem;
        color: var(--text-muted);
        padding: 4px 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .preview-item .btn-remove-item {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(229, 62, 62, 0.85);
        color: white;
        border: none;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .preview-item .btn-remove-item:hover {
        background: #c53030;
        transform: scale(1.1);
    }

    .file-count {
        text-align: center;
        color: var(--accent-color);
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 12px;
    }

    .btn-primary-custom {
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        border: none;
        color: white;
        padding: 16px 40px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
        color: white;
    }

    .btn-primary-custom:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-custom {
        width: 50px;
        height: 50px;
        border: 3px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: var(--primary-light);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .mobile-options {
        display: none;
        gap: 12px;
        margin-top: 16px;
    }

    .mobile-btn {
        background: var(--card-bg);
        border: 2px solid #e2e8f0;
        color: var(--text-dark);
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .mobile-btn:hover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.05);
    }

    .mobile-btn i {
        margin-right: 8px;
    }

    @media (max-width: 768px) {
        .mobile-options {
            display: flex;
        }
        .dropzone {
            min-height: 180px;
            padding: 24px 16px;
        }
        .dropzone-icon {
            font-size: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-cloud-upload me-2"></i>上傳檢查圖片
        </h1>
        <p class="page-subtitle">拍攝或選擇病患的復健 App 截圖（可多張）</p>
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card">
            <label for="operator_name" class="form-label">
                <i class="bi bi-person me-1"></i>操作者姓名 *
            </label>
            <input type="text" class="form-control" id="operator_name" name="operator_name"
                   placeholder="請輸入您的姓名" required>
        </div>

        <div class="card">
            <div class="dropzone" id="dropzone">
                <div class="default-content">
                    <i class="bi bi-camera dropzone-icon"></i>
                    <p class="dropzone-text">點擊拍照或選擇圖片</p>
                    <p class="dropzone-subtext">支援 JPG, PNG 格式，可選多張</p>
                </div>
                <input type="file" id="fileInput" name="image" accept="image/*" multiple style="display: none;">
                <input type="file" id="cameraInput" name="camera_image" accept="image/*" capture="environment" style="display: none;">
                <div class="preview-container" id="previewContainer" style="display: none;"></div>
            </div>

            <div class="mobile-options" id="mobileOptions">
                <button type="button" class="mobile-btn" id="cameraBtn">
                    <i class="bi bi-camera-fill"></i>拍照
                </button>
                <button type="button" class="mobile-btn" id="galleryBtn">
                    <i class="bi bi-images"></i>相簿
                </button>
            </div>
        </div>

        <button type="submit" class="btn-primary-custom" id="submitBtn" disabled>
            <i class="bi bi-arrow-right-circle me-2"></i>下一步
        </button>
    </form>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-custom"></div>
    <h4 style="color: var(--primary-color); font-weight: 600;">正在上傳圖片</h4>
    <p style="color: var(--text-muted);">請稍候...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const previewContainer = document.getElementById('previewContainer');
    const defaultContent = dropzone.querySelector('.default-content');
    const submitBtn = document.getElementById('submitBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryBtn = document.getElementById('galleryBtn');

    let selectedFiles = [];

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function syncFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(function(f) { dt.items.add(f); });
        fileInput.files = dt.files;
        submitBtn.disabled = selectedFiles.length === 0;
        if (selectedFiles.length > 0) {
            dropzone.classList.add('has-file');
            defaultContent.style.display = 'none';
            previewContainer.style.display = 'block';
        } else {
            dropzone.classList.remove('has-file');
            defaultContent.style.display = 'flex';
            previewContainer.style.display = 'none';
            while (previewContainer.firstChild) {
                previewContainer.removeChild(previewContainer.firstChild);
            }
        }
    }

    function renderPreviews() {
        while (previewContainer.firstChild) {
            previewContainer.removeChild(previewContainer.firstChild);
        }
        if (selectedFiles.length === 0) {
            syncFileInput();
            return;
        }

        var grid = document.createElement('div');
        grid.className = 'preview-grid';

        selectedFiles.forEach(function(file, idx) {
            var item = document.createElement('div');
            item.className = 'preview-item';

            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-remove-item';
            var removeIcon = document.createElement('i');
            removeIcon.className = 'bi bi-x';
            removeBtn.appendChild(removeIcon);
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                selectedFiles.splice(idx, 1);
                syncFileInput();
                renderPreviews();
            });

            var img = document.createElement('img');
            img.alt = file.name;
            var reader = new FileReader();
            reader.onload = function(e) { img.src = e.target.result; };
            reader.readAsDataURL(file);

            var name = document.createElement('div');
            name.className = 'preview-item-name';
            name.textContent = file.name;

            item.appendChild(removeBtn);
            item.appendChild(img);
            item.appendChild(name);
            grid.appendChild(item);
        });

        previewContainer.appendChild(grid);

        var countEl = document.createElement('div');
        countEl.className = 'file-count';
        var checkIcon = document.createElement('i');
        checkIcon.className = 'bi bi-check-circle me-1';
        countEl.appendChild(checkIcon);
        countEl.appendChild(
            document.createTextNode(selectedFiles.length + ' 張圖片已選擇')
        );
        previewContainer.appendChild(countEl);

        syncFileInput();
    }

    function handleFiles(fileList) {
        Array.from(fileList).forEach(function(file) {
            if (file.type.startsWith('image/')) {
                selectedFiles.push(file);
            }
        });
        renderPreviews();
    }

    dropzone.addEventListener('click', function(e) {
        if (e.target.closest('.preview-item')) return;
        if (e.target.closest('.mobile-options')) return;
        if (!isMobile()) {
            fileInput.click();
        }
    });

    cameraBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        cameraInput.click();
    });

    galleryBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) handleFiles(this.files);
    });

    cameraInput.addEventListener('change', function() {
        if (this.files.length > 0) handleFiles(this.files);
    });

    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
    });

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var operatorName = document.getElementById('operator_name').value;
        if (!operatorName.trim()) {
            alert('請輸入操作者姓名');
            return;
        }
        if (selectedFiles.length === 0) {
            alert('請選擇或拍攝至少一張圖片');
            return;
        }
        syncFileInput();
        document.getElementById('loadingOverlay').classList.add('active');
        this.submit();
    });
});
</script>
{% endblock %}
