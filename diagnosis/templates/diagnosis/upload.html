{% extends 'diagnosis/base.html' %}

{% block title %}上傳檢查圖片 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #0a192f 0%, #112240 25%, #1a365d 50%, #2d4a6e 75%, #3d5a80 100%);
        color: #e6f1ff;
        min-height: 100vh;
    }

    .upload-container {
        padding: 40px 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .page-title {
        color: #64ffda;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .page-subtitle {
        color: #8892b0;
        font-size: 1.1rem;
    }

    .form-label {
        color: #ccd6f6;
        font-weight: 500;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #e6f1ff;
        border-radius: 10px;
        padding: 12px;
    }

    .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: #64ffda;
        color: #e6f1ff;
        box-shadow: 0 0 0 0.25rem rgba(100, 255, 218, 0.25);
    }

    .form-control::placeholder {
        color: #8892b0;
    }

    .dropzone {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        padding: 40px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.03);
        min-height: 280px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .dropzone:hover {
        border-color: #64ffda;
        background: rgba(100, 255, 218, 0.05);
        transform: translateY(-2px);
    }

    .dropzone.dragover {
        border-color: #64ffda;
        background: rgba(100, 255, 218, 0.1);
        transform: scale(1.02);
    }

    .dropzone.has-file {
        border-color: #4facfe;
        background: rgba(79, 172, 254, 0.1);
    }

    .dropzone-icon {
        font-size: 4rem;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .dropzone:hover .dropzone-icon {
        color: #64ffda;
        transform: scale(1.1);
    }

    .dropzone-text {
        color: #ccd6f6;
        font-weight: 500;
        font-size: 1.1rem;
    }

    .dropzone-subtext {
        color: #8892b0;
        font-size: 0.9rem;
        margin-top: 8px;
    }

    .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        margin-bottom: 15px;
    }

    .btn-primary-glow {
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        border: none;
        color: white;
        padding: 15px 40px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.4);
        width: 100%;
    }

    .btn-primary-glow:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 30px rgba(79, 172, 254, 0.6);
        color: white;
    }

    .btn-primary-glow:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 25, 47, 0.9);
        backdrop-filter: blur(5px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-custom {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(100, 255, 218, 0.3);
        border-radius: 50%;
        border-top-color: #64ffda;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .mobile-options {
        display: none;
        gap: 10px;
        margin-top: 15px;
    }

    .mobile-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ccd6f6;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
    }

    .mobile-btn:hover {
        background: rgba(100, 255, 218, 0.1);
        border-color: #64ffda;
    }

    .mobile-btn i {
        margin-right: 8px;
    }

    @media (max-width: 768px) {
        .mobile-options {
            display: flex;
        }
        .dropzone {
            min-height: 200px;
            padding: 30px 20px;
        }
        .dropzone-icon {
            font-size: 3rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="text-center mb-4">
        <h1 class="page-title">上傳檢查圖片</h1>
        <p class="page-subtitle">拍攝或選擇病患的復健 App 截圖</p>
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="glass-card">
            <label for="operator_name" class="form-label mb-2">操作者姓名 *</label>
            <input type="text" class="form-control" id="operator_name" name="operator_name"
                   placeholder="請輸入您的姓名" required>
        </div>

        <div class="glass-card">
            <div class="dropzone" id="dropzone">
                <div class="default-content">
                    <i class="bi bi-camera dropzone-icon"></i>
                    <p class="dropzone-text">點擊拍照或選擇圖片</p>
                    <p class="dropzone-subtext">支援 JPG, PNG 格式</p>
                </div>
                <input type="file" id="fileInput" name="image" accept="image/*" style="display: none;">
                <input type="file" id="cameraInput" name="camera_image" accept="image/*" capture="environment" style="display: none;">
                <div class="preview-container" id="previewContainer" style="display: none;"></div>
            </div>

            <div class="mobile-options" id="mobileOptions">
                <button type="button" class="mobile-btn" id="cameraBtn">
                    <i class="bi bi-camera-fill"></i>拍照
                </button>
                <button type="button" class="mobile-btn" id="galleryBtn">
                    <i class="bi bi-images"></i>相簿
                </button>
            </div>
        </div>

        <button type="submit" class="btn-primary-glow" id="submitBtn" disabled>
            <i class="bi bi-arrow-right-circle me-2"></i>下一步
        </button>
    </form>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-custom"></div>
    <h4 style="color: #64ffda; font-weight: 600;">正在上傳圖片</h4>
    <p style="color: #8892b0;">請稍候...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const previewContainer = document.getElementById('previewContainer');
    const defaultContent = dropzone.querySelector('.default-content');
    const submitBtn = document.getElementById('submitBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryBtn = document.getElementById('galleryBtn');

    let selectedFile = null;

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Desktop: click dropzone to open file picker
    dropzone.addEventListener('click', function(e) {
        if (e.target.closest('.mobile-options')) return;
        if (!isMobile()) {
            fileInput.click();
        }
    });

    // Mobile: camera button
    cameraBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        cameraInput.click();
    });

    // Mobile: gallery button
    galleryBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    // Handle file selection from gallery
    fileInput.addEventListener('change', function() {
        if (this.files[0]) {
            handleFile(this.files[0]);
        }
    });

    // Handle file selection from camera
    cameraInput.addEventListener('change', function() {
        if (this.files[0]) {
            handleFile(this.files[0]);
            // Copy to main file input for form submission
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(this.files[0]);
            fileInput.files = dataTransfer.files;
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            handleFile(file);
        }
    });

    function handleFile(file) {
        if (!file) return;

        selectedFile = file;
        dropzone.classList.add('has-file');
        defaultContent.style.display = 'none';
        previewContainer.style.display = 'block';
        submitBtn.disabled = false;

        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <img src="${e.target.result}" class="preview-image" alt="預覽圖">
                <p class="mb-0" style="color: #64ffda;">
                    <i class="bi bi-check-circle me-1"></i>${file.name}
                </p>
                <button type="button" class="btn btn-sm mt-2" id="removeBtn"
                        style="color: #ff6b6b; background: rgba(255,107,107,0.1); border: 1px solid rgba(255,107,107,0.3);">
                    <i class="bi bi-x-circle me-1"></i>移除
                </button>
            `;

            document.getElementById('removeBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                resetUpload();
            });
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        selectedFile = null;
        fileInput.value = '';
        cameraInput.value = '';
        dropzone.classList.remove('has-file');
        defaultContent.style.display = 'flex';
        previewContainer.style.display = 'none';
        previewContainer.innerHTML = '';
        submitBtn.disabled = true;
    }

    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const operatorName = document.getElementById('operator_name').value;
        if (!operatorName.trim()) {
            alert('請輸入操作者姓名');
            return;
        }

        if (!fileInput.files[0]) {
            alert('請選擇或拍攝一張圖片');
            return;
        }

        document.getElementById('loadingOverlay').classList.add('active');
        this.submit();
    });
});
</script>
{% endblock %}
