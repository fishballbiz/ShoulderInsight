{% extends 'diagnosis/base.html' %}

{% block title %}上傳檢查圖片 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        padding: 40px 20px;
        max-width: 600px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .page-title {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .page-subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .card {
        background: var(--card-bg);
        border: none;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .form-control {
        background: var(--bg-light);
        border: 2px solid #e2e8f0;
        color: var(--text-dark);
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background: #fff;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    .form-control::placeholder {
        color: #a0aec0;
    }

    .dropzone {
        border: 2px dashed #cbd5e0;
        border-radius: 16px;
        padding: 40px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-light);
        min-height: 240px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .dropzone:hover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.05);
    }

    .dropzone.dragover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.1);
        transform: scale(1.01);
    }

    .dropzone.has-file {
        border-color: var(--accent-color);
        background: rgba(72, 187, 120, 0.05);
    }

    .dropzone-icon {
        font-size: 3.5rem;
        color: #a0aec0;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .dropzone:hover .dropzone-icon {
        color: var(--primary-light);
        transform: scale(1.1);
    }

    .dropzone-text {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 4px;
    }

    .dropzone-subtext {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .preview-image {
        max-width: 100%;
        max-height: 180px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 12px;
    }

    .file-name {
        color: var(--accent-color);
        font-weight: 500;
    }

    .btn-remove {
        color: #e53e3e;
        background: rgba(229, 62, 62, 0.1);
        border: 1px solid rgba(229, 62, 62, 0.2);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 0.85rem;
        margin-top: 8px;
        transition: all 0.2s ease;
    }

    .btn-remove:hover {
        background: rgba(229, 62, 62, 0.15);
        color: #c53030;
    }

    .btn-primary-custom {
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        border: none;
        color: white;
        padding: 16px 40px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
        color: white;
    }

    .btn-primary-custom:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-custom {
        width: 50px;
        height: 50px;
        border: 3px solid #e2e8f0;
        border-radius: 50%;
        border-top-color: var(--primary-light);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .mobile-options {
        display: none;
        gap: 12px;
        margin-top: 16px;
    }

    .mobile-btn {
        background: var(--card-bg);
        border: 2px solid #e2e8f0;
        color: var(--text-dark);
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .mobile-btn:hover {
        border-color: var(--primary-light);
        background: rgba(66, 153, 225, 0.05);
    }

    .mobile-btn i {
        margin-right: 8px;
    }

    @media (max-width: 768px) {
        .mobile-options {
            display: flex;
        }
        .dropzone {
            min-height: 180px;
            padding: 24px 16px;
        }
        .dropzone-icon {
            font-size: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-cloud-upload me-2"></i>上傳檢查圖片
        </h1>
        <p class="page-subtitle">拍攝或選擇病患的復健 App 截圖</p>
    </div>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card">
            <label for="operator_name" class="form-label">
                <i class="bi bi-person me-1"></i>操作者姓名 *
            </label>
            <input type="text" class="form-control" id="operator_name" name="operator_name"
                   placeholder="請輸入您的姓名" required>
        </div>

        <div class="card">
            <div class="dropzone" id="dropzone">
                <div class="default-content">
                    <i class="bi bi-camera dropzone-icon"></i>
                    <p class="dropzone-text">點擊拍照或選擇圖片</p>
                    <p class="dropzone-subtext">支援 JPG, PNG 格式</p>
                </div>
                <input type="file" id="fileInput" name="image" accept="image/*" style="display: none;">
                <input type="file" id="cameraInput" name="camera_image" accept="image/*" capture="environment" style="display: none;">
                <div class="preview-container" id="previewContainer" style="display: none;"></div>
            </div>

            <div class="mobile-options" id="mobileOptions">
                <button type="button" class="mobile-btn" id="cameraBtn">
                    <i class="bi bi-camera-fill"></i>拍照
                </button>
                <button type="button" class="mobile-btn" id="galleryBtn">
                    <i class="bi bi-images"></i>相簿
                </button>
            </div>
        </div>

        <button type="submit" class="btn-primary-custom" id="submitBtn" disabled>
            <i class="bi bi-arrow-right-circle me-2"></i>下一步
        </button>
    </form>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-custom"></div>
    <h4 style="color: var(--primary-color); font-weight: 600;">正在上傳圖片</h4>
    <p style="color: var(--text-muted);">請稍候...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const previewContainer = document.getElementById('previewContainer');
    const defaultContent = dropzone.querySelector('.default-content');
    const submitBtn = document.getElementById('submitBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const galleryBtn = document.getElementById('galleryBtn');

    let selectedFile = null;

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    dropzone.addEventListener('click', function(e) {
        if (e.target.closest('.mobile-options')) return;
        if (!isMobile()) {
            fileInput.click();
        }
    });

    cameraBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        cameraInput.click();
    });

    galleryBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files[0]) handleFile(this.files[0]);
    });

    cameraInput.addEventListener('change', function() {
        if (this.files[0]) {
            handleFile(this.files[0]);
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(this.files[0]);
            fileInput.files = dataTransfer.files;
        }
    });

    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            handleFile(file);
        }
    });

    function handleFile(file) {
        if (!file) return;
        selectedFile = file;
        dropzone.classList.add('has-file');
        defaultContent.style.display = 'none';
        previewContainer.style.display = 'block';
        submitBtn.disabled = false;

        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <img src="${e.target.result}" class="preview-image" alt="預覽圖">
                <p class="file-name mb-0">
                    <i class="bi bi-check-circle me-1"></i>${file.name}
                </p>
                <button type="button" class="btn-remove" id="removeBtn">
                    <i class="bi bi-x-circle me-1"></i>移除
                </button>
            `;
            document.getElementById('removeBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                resetUpload();
            });
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        selectedFile = null;
        fileInput.value = '';
        cameraInput.value = '';
        dropzone.classList.remove('has-file');
        defaultContent.style.display = 'flex';
        previewContainer.style.display = 'none';
        previewContainer.innerHTML = '';
        submitBtn.disabled = true;
    }

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const operatorName = document.getElementById('operator_name').value;
        if (!operatorName.trim()) {
            alert('請輸入操作者姓名');
            return;
        }
        if (!fileInput.files[0]) {
            alert('請選擇或拍攝一張圖片');
            return;
        }
        document.getElementById('loadingOverlay').classList.add('active');
        this.submit();
    });
});
</script>
{% endblock %}
