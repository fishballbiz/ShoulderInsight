{% extends 'diagnosis/base.html' %}
{% load static %}

{% block title %}AI 分析中 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    .analyzing-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 70px);
        text-align: center;
        padding: 40px 20px;
    }

    .analyzing-text {
        margin-bottom: 30px;
    }

    .analyzing-text h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 12px;
    }

    .analyzing-text p {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin: 0;
    }

    .dots::after {
        content: '';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }

    .video-container {
        width: 100%;
        max-width: 420px;
        margin: 20px 0;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(44, 82, 130, 0.12);
        background: var(--card-bg);
    }

    .tai-chi-video {
        width: 100%;
        height: auto;
        display: block;
    }

    .progress-section {
        width: 100%;
        max-width: 380px;
        margin-top: 30px;
    }

    .progress-bar-container {
        width: 100%;
        height: 10px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        border-radius: 10px;
        transition: width 0.3s ease-out;
    }

    .progress-text {
        margin-top: 12px;
        font-size: 0.95rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    .progress-percent {
        color: var(--primary-color);
        font-weight: 700;
    }

    .trust-badges {
        display: flex;
        gap: 24px;
        margin-top: 40px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .trust-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .trust-badge i {
        color: var(--accent-color);
        font-size: 1.1rem;
    }

    .brand-footer {
        margin-top: 40px;
        color: #a0aec0;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="analyzing-container">
    <div class="analyzing-text">
        <h1><i class="bi bi-cpu me-2"></i>AI 正在分析您的數據<span class="dots"></span></h1>
        <p>正在分析 {{ image_count }} 張圖片，請稍候</p>
    </div>

    <div class="video-container">
        <video id="taiChiVideo" class="tai-chi-video" muted playsinline loop autoplay>
            <source src="{% static 'diagnosis/Looping_Tai_Chi_Animation_For_Healing.mp4' %}" type="video/mp4">
        </video>
    </div>

    <div class="progress-section">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text">分析進度 <span class="progress-percent" id="progressPercent">0</span>%</p>
    </div>

    <div class="trust-badges">
        <div class="trust-badge">
            <i class="bi bi-shield-check"></i>
            <span>資料安全加密</span>
        </div>
        <div class="trust-badge">
            <i class="bi bi-award"></i>
            <span>專業醫療認證</span>
        </div>
        <div class="trust-badge">
            <i class="bi bi-lightning-charge"></i>
            <span>AI 智能分析</span>
        </div>
    </div>

    <div class="brand-footer">
        智慧肩部復健 AI 診斷平台
    </div>
</div>

<script>
    const video = document.getElementById('taiChiVideo');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');

    video.addEventListener('loadedmetadata', function() {
        video.play().catch(e => console.error('Play error:', e));
    });

    let progress = 0;
    let targetProgress = 0;
    let lastUpdate = Date.now();
    let analysisComplete = false;

    function updateProgress() {
        if (analysisComplete) {
            progressBar.style.width = '100%';
            progressPercent.textContent = '100';
            return;
        }

        const now = Date.now();
        const timeSinceLastUpdate = now - lastUpdate;

        if (timeSinceLastUpdate > Math.random() * 1200 + 300) {
            const remaining = 100 - progress;
            const maxJump = remaining * 0.1;
            const minJump = remaining * 0.01;
            const jump = Math.random() * (maxJump - minJump) + minJump;
            targetProgress = Math.min(95, progress + jump);
            lastUpdate = now;
        }

        progress += (targetProgress - progress) * 0.05;
        progressBar.style.width = progress + '%';
        progressPercent.textContent = Math.floor(progress);

        requestAnimationFrame(updateProgress);
    }

    updateProgress();

    fetch("{% url 'diagnosis:analyze_api' examination_id=examination_id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        analysisComplete = true;
        if (data.redirect_url) {
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 500);
        } else if (data.error) {
            alert('分析失敗: ' + data.error);
            window.location.href = "{% url 'diagnosis:upload' %}";
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        alert('分析請求失敗，請重試');
        window.location.href = "{% url 'diagnosis:upload' %}";
    });
</script>
{% endblock %}
