{% extends 'diagnosis/base.html' %}
{% load static %}

{% block title %}AI 分析中 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 50%, #f0f4f8 100%);
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .analyzing-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .analyzing-text {
        margin-bottom: 30px;
        z-index: 20;
    }

    .analyzing-text h1 {
        font-size: 2rem;
        font-weight: 600;
        color: #2c5282;
        margin-bottom: 10px;
        letter-spacing: 0.5px;
    }

    .analyzing-text p {
        font-size: 1.1rem;
        color: #718096;
        margin: 0;
    }

    .dots::after {
        content: '';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }

    .video-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 20px 0;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(44, 82, 130, 0.15);
        background: #fff;
    }

    .tai-chi-video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 20px;
    }

    .progress-section {
        width: 100%;
        max-width: 400px;
        margin-top: 30px;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4299e1, #63b3ed, #4299e1);
        background-size: 200% 100%;
        border-radius: 10px;
        transition: width 0.3s ease-out;
        animation: gradient-move 2s linear infinite;
    }

    @keyframes gradient-move {
        0% { background-position: 0% center; }
        100% { background-position: 200% center; }
    }

    .progress-text {
        margin-top: 15px;
        font-size: 0.9rem;
        color: #a0aec0;
    }

    .trust-badges {
        display: flex;
        gap: 30px;
        margin-top: 40px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .trust-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #718096;
        font-size: 0.85rem;
    }

    .trust-badge i {
        color: #48bb78;
        font-size: 1.1rem;
    }

    .brand-footer {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: #cbd5e0;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="analyzing-container">
    <div class="analyzing-text">
        <h1>AI 正在分析您的數據<span class="dots"></span></h1>
        <p>請稍候，我們正在為您產生專業診斷報告</p>
    </div>

    <div class="video-container">
        <video id="taiChiVideo" class="tai-chi-video" muted playsinline loop autoplay>
            <source src="{% static 'diagnosis/Looping_Tai_Chi_Animation_For_Healing.mp4' %}" type="video/mp4">
        </video>
    </div>

    <div class="progress-section">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text">分析進度 <span id="progressPercent">0</span>%</p>
    </div>

    <div class="trust-badges">
        <div class="trust-badge">
            <i class="bi bi-shield-check"></i>
            <span>資料安全加密</span>
        </div>
        <div class="trust-badge">
            <i class="bi bi-award"></i>
            <span>專業醫療認證</span>
        </div>
        <div class="trust-badge">
            <i class="bi bi-lightning-charge"></i>
            <span>AI 智能分析</span>
        </div>
    </div>

    <div class="brand-footer">
        智慧肩部復健 AI 診斷平台
    </div>
</div>

<script>
    const video = document.getElementById('taiChiVideo');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');

    video.addEventListener('loadedmetadata', function() {
        video.play().catch(e => console.error('Play error:', e));
    });

    let progress = 0;
    let targetProgress = 0;
    let lastUpdate = Date.now();

    function updateProgress() {
        const now = Date.now();
        const timeSinceLastUpdate = now - lastUpdate;

        if (timeSinceLastUpdate > Math.random() * 1200 + 300) {
            const remaining = 100 - progress;
            const maxJump = remaining * 0.1;
            const minJump = remaining * 0.01;
            const jump = Math.random() * (maxJump - minJump) + minJump;
            targetProgress = Math.min(99.9, progress + jump);
            lastUpdate = now;
        }

        progress += (targetProgress - progress) * 0.05;
        progressBar.style.width = progress + '%';
        progressPercent.textContent = Math.floor(progress);

        requestAnimationFrame(updateProgress);
    }

    updateProgress();

    setTimeout(function() {
        window.location.href = "{% url 'diagnosis:result' examination_id=examination_id %}";
    }, 8000);
</script>
{% endblock %}
