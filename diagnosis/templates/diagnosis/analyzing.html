{% extends 'diagnosis/base.html' %}
{% load static %}

{% block title %}AI 分析中 - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg,
                #0a192f 0%,
                #112240 25%,
                #1a365d 50%,
                #2d4a6e 75%,
                #3d5a80 100%);
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .analyzing-container {
        display: grid;
        grid-template-rows: 0.8fr auto 1.2fr;
        justify-items: center;
        align-items: center;
        min-height: 100vh;
        color: white;
        text-align: center;
        position: relative;
        padding: 20px;
        box-sizing: border-box;
    }

    /* Text animations */
    .analyzing-text {
        align-self: end;
        margin-bottom: 40px;
        z-index: 20;
        position: relative;
    }

    /* Video Container - Larger and Centered */
    .video-container {
        position: relative;
        margin: 0;
        width: 90%;
        max-width: 1000px;
        border-radius: 30px;
        overflow: visible;
        flex-shrink: 0;
    }

    .tai-chi-video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 30px;
        mask-image: radial-gradient(ellipse 85% 80% at 50% 50%,
                black 30%,
                rgba(0, 0, 0, 0.7) 50%,
                rgba(0, 0, 0, 0.3) 70%,
                transparent 85%);
        -webkit-mask-image: radial-gradient(ellipse 85% 80% at 50% 50%,
                black 30%,
                rgba(0, 0, 0, 0.7) 50%,
                rgba(0, 0, 0, 0.3) 70%,
                transparent 85%);
    }

    /* Progress Bar */
    .progress-bar-container {
        align-self: start;
        margin-top: 10px;
        width: 90%;
        max-width: 1000px;
        height: 6px;
        background: rgba(79, 172, 254, 0.15);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.2);
        flex-shrink: 0;
    }

    .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4facfe, #00f2fe, #4facfe);
        background-size: 200% 100%;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(79, 172, 254, 0.6);
        position: relative;
        transition: width 0.3s ease-out;
        animation: gradient-move 3s linear infinite;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 1.5s ease-in-out infinite;
    }

    @keyframes gradient-move {
        0% {
            background-position: 0% center;
        }

        100% {
            background-position: 200% center;
        }
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }

        100% {
            transform: translateX(100%);
        }
    }

    /* Text animations */
    .analyzing-text {
        margin-bottom: 40px;
        z-index: 20;
        position: relative;
    }

    .analyzing-text h1 {
        font-size: 2.8rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: #4facfe;
        text-shadow: 0 0 30px rgba(79, 172, 254, 0.5);
        display: inline-block;
        position: relative;
    }

    .dots {
        position: absolute;
        left: 100%;
        bottom: 0;
        text-align: left;
    }

    .dots::after {
        content: '';
        animation: dots 1.5s steps(4, end) infinite;
        display: inline-block;
        width: 1.5em;
        /* Reserve space for 3 dots */
    }

    /* Animated background particles */
    .particles {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        overflow: hidden;
        z-index: 1;
        pointer-events: none;
    }

    .particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(79, 172, 254, 0.8);
        border-radius: 50%;
        animation: float-particle 12s linear infinite;
        box-shadow: 0 0 15px rgba(79, 172, 254, 1);
    }

    .particle:nth-child(1) {
        left: 10%;
        animation-delay: 0s;
        animation-duration: 10s;
    }

    .particle:nth-child(2) {
        left: 20%;
        animation-delay: 2s;
        animation-duration: 12s;
    }

    .particle:nth-child(3) {
        left: 30%;
        animation-delay: 4s;
        animation-duration: 14s;
    }

    .particle:nth-child(4) {
        left: 40%;
        animation-delay: 1s;
        animation-duration: 11s;
    }

    .particle:nth-child(5) {
        left: 50%;
        animation-delay: 3s;
        animation-duration: 13s;
    }

    .particle:nth-child(6) {
        left: 60%;
        animation-delay: 5s;
        animation-duration: 15s;
    }

    .particle:nth-child(7) {
        left: 70%;
        animation-delay: 1.5s;
        animation-duration: 10.5s;
    }

    .particle:nth-child(8) {
        left: 80%;
        animation-delay: 3.5s;
        animation-duration: 12.5s;
    }

    .particle:nth-child(9) {
        left: 90%;
        animation-delay: 2.5s;
        animation-duration: 11.5s;
    }

    @keyframes float-particle {
        0% {
            bottom: -20px;
            opacity: 0;
            transform: translateX(0);
        }

        10% {
            opacity: 1;
        }

        90% {
            opacity: 1;
        }

        100% {
            bottom: 110vh;
            opacity: 0;
            transform: translateX(30px);
        }
    }

    @keyframes dots {

        0%,
        20% {
            content: '';
        }

        40% {
            content: '.';
        }

        60% {
            content: '..';
        }

        80%,
        100% {
            content: '...';
        }
    }

    /* Glow effect around video */
    .video-glow {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background: radial-gradient(circle, rgba(79, 172, 254, 0.2) 0%, transparent 70%);
        animation: pulse-glow 3s ease-in-out infinite;
        z-index: 0;
        border-radius: 20px;
    }

    @keyframes pulse-glow {

        0%,
        100% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analyzing-container">
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="analyzing-text">
        <h1>AI 正在分析您的數據<span class="dots"></span></h1>
    </div>

    <div class="video-container">
        <div class="video-glow"></div>
        <video id="taiChiVideo" class="tai-chi-video" muted playsinline loop autoplay>
            <source src="{% static 'diagnosis/Looping_Tai_Chi_Animation_For_Healing.mp4' %}" type="video/mp4">
        </video>
    </div>

    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
</div>

<script>
    const video = document.getElementById('taiChiVideo');
    const progressBar = document.getElementById('progressBar');

    // Ensure video plays
    video.addEventListener('loadedmetadata', function () {
        console.log('Video loaded, playing continuously');
        video.play().catch(e => console.error('Play error:', e));
    });

    // Irregular asymptotic progress bar
    let progress = 0;
    let targetProgress = 0;
    let lastUpdate = Date.now();

    function updateProgress() {
        const now = Date.now();
        const timeSinceLastUpdate = now - lastUpdate;

        // Random irregular jumps every 300-1500ms
        if (timeSinceLastUpdate > Math.random() * 1200 + 300) {
            // Calculate asymptotic behavior: slower as it approaches 100
            const remaining = 100 - progress;

            // Jump size decreases significantly as we get closer to 100
            // Max jump is 10% of remaining distance, Min is 1%
            const maxJump = remaining * 0.1;
            const minJump = remaining * 0.01;

            // Add randomness to the jump
            const jump = Math.random() * (maxJump - minJump) + minJump;

            // Cap at 99.9% so it never reaches 100%
            targetProgress = Math.min(99.9, progress + jump);
            lastUpdate = now;
        }

        // Smooth interpolation to target
        // Slower interpolation factor (0.05) for smoother, more organic feel
        progress += (targetProgress - progress) * 0.05;

        // Update progress bar width
        progressBar.style.width = progress + '%';

        requestAnimationFrame(updateProgress);
    }

    // Start progress animation
    updateProgress();
</script>
{% endblock %}