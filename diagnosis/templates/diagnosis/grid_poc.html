{% extends 'diagnosis/base.html' %}

{% block title %}Grid Detection POC - 智慧肩部復健 AI 診斷平台{% endblock %}

{% block extra_css %}
<style>
    .poc-container {
        padding: 40px 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .page-header h1 {
        color: var(--primary-color);
        font-weight: 700;
    }

    .page-header p {
        color: var(--text-muted);
    }

    .result-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e2e8f0;
    }

    .filename {
        font-weight: 600;
        color: var(--text-dark);
        font-family: monospace;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status-success {
        background: #c6f6d5;
        color: #22543d;
    }

    .status-error {
        background: #fed7d7;
        color: #822727;
    }

    .images-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .images-row {
            grid-template-columns: 1fr;
        }
    }

    .image-container {
        text-align: center;
    }

    .image-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .image-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 8px;
    }

    .grid-info {
        background: var(--bg-light);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .grid-info-title {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .grid-info-item {
        display: inline-block;
        margin-right: 20px;
        font-size: 0.9rem;
    }

    .grid-info-item label {
        color: var(--text-muted);
    }

    .grid-info-item span {
        font-weight: 500;
        color: var(--text-dark);
    }

    .detected-grid {
        margin-top: 20px;
    }

    .detected-grid-title {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    .grid-display {
        display: grid;
        grid-template-columns: repeat(9, 40px);
        gap: 2px;
        max-width: fit-content;
        margin: 0 auto;
        background: #718096;
        padding: 2px;
        border-radius: 8px;
    }

    .grid-cell {
        width: 40px;
        height: 40px;
        border-radius: 2px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 500;
        background: #f7fafc;
    }

    .grid-cell .cell-num {
        font-size: 0.65rem;
        color: #a0aec0;
    }

    .grid-cell .cell-size {
        font-size: 0.8rem;
        font-weight: 700;
        color: white;
    }

    .grid-cell.GREEN {
        background: linear-gradient(135deg, #68d391, #38a169);
    }

    .grid-cell.CYAN {
        background: linear-gradient(135deg, #76e4f7, #0bc5ea);
    }

    .grid-cell.BLUE {
        background: linear-gradient(135deg, #63b3ed, #3182ce);
    }

    .grid-cell.RED {
        background: linear-gradient(135deg, #fc8181, #e53e3e);
    }

    .grid-cell.YELLOW {
        background: linear-gradient(135deg, #f6e05e, #d69e2e);
    }

    .grid-cell.GREEN .cell-num,
    .grid-cell.CYAN .cell-num,
    .grid-cell.BLUE .cell-num,
    .grid-cell.RED .cell-num,
    .grid-cell.YELLOW .cell-num {
        color: rgba(255,255,255,0.8);
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 3px;
    }

    .legend-dot.green { background: #38a169; }
    .legend-dot.cyan { background: #0bc5ea; }
    .legend-dot.blue { background: #3182ce; }
    .legend-dot.red { background: #e53e3e; }
    .legend-dot.yellow { background: #d69e2e; }
    .legend-dot.empty { background: #cbd5e0; }

    .error-message {
        color: #e53e3e;
        padding: 20px;
        text-align: center;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .stat-item {
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="poc-container">
    <div class="page-header">
        <h1><i class="bi bi-grid-3x3-gap me-2"></i>Grid Detection POC</h1>
        <p>Testing OpenCV-based grid detection on sample images</p>
    </div>

    {% if not results %}
    <div class="result-card">
        <p class="text-center text-muted">No test images found in data/test_inputs/</p>
    </div>
    {% endif %}

    {% for result in results %}
    <div class="result-card">
        <div class="result-header">
            <span class="filename">{{ result.filename }}</span>
            {% if result.error %}
            <span class="status-badge status-error">Detection Failed</span>
            {% else %}
            <span class="status-badge status-success">Detection OK</span>
            {% endif %}
        </div>

        {% if result.error %}
        <div class="error-message">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ result.error }}
        </div>
        {% else %}
        <div class="images-row">
            <div class="image-container">
                <div class="image-label">Original Image</div>
                <img src="data:image/jpeg;base64,{{ result.original_base64 }}" alt="Original">
            </div>
            <div class="image-container">
                <div class="image-label">Detection Visualization</div>
                <img src="data:image/jpeg;base64,{{ result.visualization_base64 }}" alt="Detection">
            </div>
        </div>

        <div class="grid-info">
            <div class="grid-info-title">Grid Detection Info</div>
            <div class="grid-info-item">
                <label>Bounds:</label>
                <span>({{ result.grid_info.bounds.0|floatformat:0 }}, {{ result.grid_info.bounds.1|floatformat:0 }}, {{ result.grid_info.bounds.2|floatformat:0 }}, {{ result.grid_info.bounds.3|floatformat:0 }})</span>
            </div>
            <div class="grid-info-item">
                <label>Cell Size:</label>
                <span>{{ result.grid_info.cell_size.0|floatformat:1 }} × {{ result.grid_info.cell_size.1|floatformat:1 }} px</span>
            </div>
        </div>

        <div class="detected-grid">
            <div class="detected-grid-title">Detected Grid (9×9)</div>
            <div class="grid-display">
                {% for detail in result.cell_details %}
                <div class="grid-cell {% if detail.color %}{{ detail.color }}{% endif %}">
                    <span class="cell-num">{{ detail.index }}</span>
                    {% if detail.size %}<span class="cell-size">{{ detail.size }}</span>{% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="legend">
                <div class="legend-item"><span class="legend-dot green"></span>GREEN</div>
                <div class="legend-item"><span class="legend-dot cyan"></span>CYAN</div>
                <div class="legend-item"><span class="legend-dot blue"></span>BLUE</div>
                <div class="legend-item"><span class="legend-dot red"></span>RED</div>
                <div class="legend-item"><span class="legend-dot yellow"></span>YELLOW</div>
                <div class="legend-item"><span class="legend-dot empty"></span>Empty</div>
            </div>

            <div class="stats">
                {% with colors=result.grid_color %}
                <div class="stat-item">
                    <div class="stat-label">Total Cells</div>
                    <div class="stat-value">81</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Colored</div>
                    <div class="stat-value" id="colored-{{ forloop.counter0 }}">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Empty</div>
                    <div class="stat-value" id="empty-{{ forloop.counter0 }}">-</div>
                </div>
                {% endwith %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate stats for each result
    document.querySelectorAll('.grid-display').forEach(function(grid, index) {
        const cells = grid.querySelectorAll('.grid-cell');
        let colored = 0;
        let empty = 0;

        cells.forEach(function(cell) {
            if (cell.classList.contains('empty')) {
                empty++;
            } else {
                colored++;
            }
        });

        const coloredEl = document.getElementById('colored-' + index);
        const emptyEl = document.getElementById('empty-' + index);

        if (coloredEl) coloredEl.textContent = colored;
        if (emptyEl) emptyEl.textContent = empty;
    });
});
</script>
{% endblock %}
