#!/bin/bash

# ./dc utility script

COMPOSE_FILE="docker-compose.yml"
SERVICE_NAME="web"

function show_help {
    echo "Usage: ./dc [command]"
    echo "Commands:"
    echo "  build dev       Build the docker image"
    echo "  dev             Enter the development container (bash)"
    echo "  up              Start services"
    echo "  down            Stop services"
    echo "  logs            View logs"
    echo "  manage [args]   Run python manage.py [args]"
    echo "  help            Show this help message"
}

if [ -z "$1" ]; then
    show_help
    exit 1
fi

case "$1" in
    "build")
        if [ "$2" == "dev" ]; then
            docker-compose -f $COMPOSE_FILE build
        else
            docker-compose -f $COMPOSE_FILE build "$@"
        fi
        ;;
    "dev")
        # Ensure services are up or run a one-off container
        # If we want to "enter" the image, we usually mean running bash
        docker-compose -f $COMPOSE_FILE run --rm --service-ports $SERVICE_NAME bash
        ;;
    "up")
        docker-compose -f $COMPOSE_FILE up
        ;;
    "down")
        docker-compose -f $COMPOSE_FILE down
        ;;
    "logs")
        docker-compose -f $COMPOSE_FILE logs -f
        ;;
    "manage")
        shift
        docker-compose -f $COMPOSE_FILE run --rm $SERVICE_NAME python manage.py "$@"
        ;;
    *)
        # Pass through other commands to docker-compose
        docker-compose -f $COMPOSE_FILE "$@"
        ;;
esac
