#!/bin/bash

# ./dc utility script

COMPOSE_FILE="docker-compose.yml"
SERVICE_NAME="web"

GCP_PROJECT="aishoulder"
GCP_REGION="asia-east1"
IMAGE_NAME="aishoulder"
REGISTRY="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT}/${IMAGE_NAME}/${IMAGE_NAME}"
STATIC_BUCKET="${GCP_PROJECT}-static"

function show_help {
    echo "Usage: ./dc [command]"
    echo "Commands:"
    echo "  build dev       Build the docker image"
    echo "  dev             Enter the development container (bash)"
    echo "  up              Start services"
    echo "  down            Stop services"
    echo "  logs            View logs"
    echo "  manage [args]   Run python manage.py [args]"
    echo "  publish         Deploy to GCP Cloud Run"
    echo "  help            Show this help message"
}

if [ -z "$1" ]; then
    show_help
    exit 1
fi

case "$1" in
    "build")
        if [ "$2" == "dev" ]; then
            docker-compose -f $COMPOSE_FILE build
        else
            docker-compose -f $COMPOSE_FILE build "$@"
        fi
        ;;
    "dev")
        # Ensure services are up or run a one-off container
        # If we want to "enter" the image, we usually mean running bash
        docker-compose -f $COMPOSE_FILE run --rm --service-ports $SERVICE_NAME bash
        ;;
    "up")
        docker-compose -f $COMPOSE_FILE up -d
        ;;
    "down")
        docker-compose -f $COMPOSE_FILE down
        ;;
    "logs")
        docker-compose -f $COMPOSE_FILE logs -f
        ;;
    "manage")
        shift
        docker-compose -f $COMPOSE_FILE run --rm $SERVICE_NAME python manage.py "$@"
        ;;
    "publish")
        # Check GCP account
        CURRENT_ACCOUNT=$(gcloud config get-value account 2>/dev/null)
        EXPECTED_ACCOUNT="fishbudin@gmail.com"
        if [ "$CURRENT_ACCOUNT" != "$EXPECTED_ACCOUNT" ]; then
            echo "Error: Wrong GCP account. Expected $EXPECTED_ACCOUNT, got $CURRENT_ACCOUNT"
            echo "Run: gcloud config set account $EXPECTED_ACCOUNT"
            exit 1
        fi
        echo "Using GCP account: $CURRENT_ACCOUNT"

        # Set project
        gcloud config set project $GCP_PROJECT

        # Create Artifact Registry repository if not exists
        gcloud artifacts repositories describe $IMAGE_NAME \
            --location=$GCP_REGION 2>/dev/null || \
        gcloud artifacts repositories create $IMAGE_NAME \
            --repository-format=docker \
            --location=$GCP_REGION

        # Build and push image
        echo "Building and pushing image..."
        docker build --platform linux/amd64 -t $REGISTRY:latest .
        docker push $REGISTRY:latest

        # Deploy to Cloud Run with minimal resources
        echo "Deploying to Cloud Run..."
        gcloud run deploy $IMAGE_NAME \
            --image=$REGISTRY:latest \
            --platform=managed \
            --region=$GCP_REGION \
            --allow-unauthenticated \
            --min-instances=0 \
            --max-instances=1 \
            --memory=512Mi \
            --cpu=1 \
            --concurrency=10 \
            --timeout=60 \
            --cpu-boost

        # Clean up old images (keep only latest)
        echo "Cleaning up old images..."
        gcloud artifacts docker images list $REGISTRY \
            --include-tags \
            --format="get(version)" \
            --filter="NOT tags:latest" | \
        while read -r digest; do
            if [ -n "$digest" ]; then
                gcloud artifacts docker images delete "${REGISTRY}@${digest}" --quiet 2>/dev/null || true
            fi
        done

        echo "Deployment complete!"
        gcloud run services describe $IMAGE_NAME --region=$GCP_REGION --format="value(status.url)"
        ;;
    *)
        # Pass through other commands to docker-compose
        docker-compose -f $COMPOSE_FILE "$@"
        ;;
esac
